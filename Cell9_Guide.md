# 롤링 상관계수 분석 가이드

## 개요

이 분석 도구는 금융 자산 간의 **동적 상관관계**를 분석합니다.  
4가지 핵심 지표를 통해 페어트레이딩 기회를 포착할 수 있습니다.

---

## 🔑 핵심 규칙: 스프레드 계산 순서

**모든 Mode에서 일관된 규칙:**
```
제목: "A vs B"  →  스프레드 계산: B - A (뒤 - 앞)
```

이 규칙 덕분에 제목만 보고도 계산 순서를 알 수 있습니다.

---

## Mode별 분석 내용

### 📊 입력 예시
```python
COLUMNS = ['국고채RF_3Y', '국고채RF_5Y', '국고채RF_10Y']  # [A, B, C]
```

---

## 1️⃣ `rates` 모드 (금리 수준)

**용도**: 금리 수준 자체의 상관관계 분석

### 비교 쌍 생성
| 쌍 | col1 | col2 | 스프레드 (col2−col1) |
|----|------|------|---------------------|
| 3Y vs 5Y | 3Y | 5Y | **5Y − 3Y** |
| 3Y vs 10Y | 3Y | 10Y | **10Y − 3Y** |
| 5Y vs 10Y | 5Y | 10Y | **10Y − 5Y** |

### 4가지 지표 (예: "3Y vs 5Y")
| 지표 | 계산 | 의미 |
|------|------|------|
| **상관계수** | corr(3Y, 5Y) | 두 금리가 함께 움직이는 정도 |
| **스프레드** | **5Y − 3Y** | 두 금리의 차이 (긴만기−짧은만기 = 보통 양수) |
| **변동성** | σ(5Y − 3Y) | 금리차의 롤링 표준편차 |
| **Z-score** | (현재 − 평균) / σ | 현재 금리차가 평소 대비 몇 σ 위치 |

### 해석 예시
```
제목: "3Y vs 5Y"  →  스프레드 = 5Y − 3Y

Z-score = +2.0  →  5Y-3Y 스프레드가 평소보다 2σ 넓음
                  (5년물이 상대적으로 높아짐 = 커브 스티프닝)
                  → 평균회귀 기대 시: 5Y 매도 / 3Y 매수 (플래트닝 베팅)
```

---

## 2️⃣ `rates_changes` 모드 (금리 변화)

**용도**: 금리 일간 변동의 상관관계 분석

### 비교 쌍 생성
`rates`와 동일하나, 데이터는 **일간 변화분(diff)**

### 4가지 지표 (예: "3Y vs 5Y")
| 지표 | 계산 | 의미 |
|------|------|------|
| **상관계수** | corr(Δ3Y, Δ5Y) | 일간 변동이 함께 움직이는 정도 |
| **스프레드** | **Δ5Y − Δ3Y** | 일간 변동의 차이 (뒤 − 앞) |
| **변동성** | σ(Δ5Y − Δ3Y) | 변동 차이의 표준편차 |
| **Z-score** | (현재 − 평균) / σ | 현재 변동 차이가 평소 대비 몇 σ |

### 해석 예시
```
제목: "3Y vs 5Y"  →  스프레드 = Δ5Y − Δ3Y

상관계수 = 0.95  →  두 금리가 거의 같이 움직임
상관계수 = 0.60  →  움직임에 괴리 발생 (트레이딩 기회)
스프레드 = +3bp  →  오늘 5Y가 3Y보다 3bp 더 올랐음 (스티프닝)
```

---

## 3️⃣ `spreads` 모드 (종목 간 스프레드)

**용도**: 스프레드들 간의 상관관계 분석 (커브 트레이딩)

### 1단계: 스프레드 생성 (뒤 - 앞)
| 순서 | 계산 | 의미 |
|------|------|------|
| ① | 5Y − 3Y | 3-5년 커브 스프레드 |
| ② | 10Y − 3Y | 3-10년 커브 스프레드 |
| ③ | 10Y − 5Y | 5-10년 커브 스프레드 |

### 2단계: 스프레드 쌍 비교
| 쌍 | col1 | col2 | 스프레드 (col2−col1) |
|----|------|------|---------------------|
| ① vs ② | 5Y−3Y | 10Y−3Y | **(10Y−3Y) − (5Y−3Y) = 10Y−5Y** |
| ① vs ③ | 5Y−3Y | 10Y−5Y | **(10Y−5Y) − (5Y−3Y)** |
| ② vs ③ | 10Y−3Y | 10Y−5Y | **(10Y−5Y) − (10Y−3Y) = −(5Y−3Y)** |

### 4가지 지표 (예: "(5Y−3Y) vs (10Y−3Y)")
| 지표 | 계산 | 의미 |
|------|------|------|
| **상관계수** | corr(5Y−3Y, 10Y−3Y) | 두 스프레드의 동조성 |
| **스프레드** | **(10Y−3Y) − (5Y−3Y) = 10Y−5Y** | 두 스프레드의 차이 |
| **변동성** | σ[(10Y−3Y) − (5Y−3Y)] | 스프레드 차이의 변동성 |
| **Z-score** | (현재 − 평균) / σ | 스프레드 차이가 평소 대비 몇 σ |

### 해석 예시
```
제목: "(5Y−3Y) vs (10Y−3Y)"  →  스프레드 = (10Y−3Y) − (5Y−3Y) = 10Y−5Y

상관계수 = 0.85  →  두 스프레드가 함께 확대/축소
Z-score = +2.5  →  (10Y−3Y)가 (5Y−3Y) 대비 평소보다 넓음
                  = 10Y−5Y 스프레드가 평소보다 넓음
                  → 평균회귀 기대 시: 10Y−5Y 축소 방향 베팅
```

---

## 4️⃣ `spreads_changes` 모드 (스프레드 변화)

**용도**: 스프레드 일간 변동의 상관관계 분석

### 비교 쌍 생성
`spreads`와 동일하나, 데이터는 **스프레드의 일간 변화분(diff)**

### 4가지 지표 (예: "(5Y−3Y) vs (10Y−3Y)")
| 지표 | 계산 | 의미 |
|------|------|------|
| **상관계수** | corr(Δ(5Y−3Y), Δ(10Y−3Y)) | 스프레드 변동의 동조성 |
| **스프레드** | **Δ(10Y−3Y) − Δ(5Y−3Y)** | 일간 스프레드 변동 차이 (뒤 − 앞) |
| **변동성** | σ[Δ(10Y−3Y) − Δ(5Y−3Y)] | 변동 차이의 표준편차 |
| **Z-score** | (현재 − 평균) / σ | 현재 변동 차이가 평소 대비 몇 σ |

### 해석 예시
```
제목: "(5Y−3Y) vs (10Y−3Y)"  →  스프레드 = Δ(10Y−3Y) − Δ(5Y−3Y)

스프레드 = +2bp  →  오늘 (10Y−3Y)가 (5Y−3Y)보다 2bp 더 확대됨
```

---

## 5️⃣ `spreads_vs_ktb` 모드 (국고채 대비 스프레드)

**용도**: 크레딧 스프레드 간 상관관계 분석

### 입력 예시
```python
COLUMNS = ['산금채AAA_5Y', '카드채AA+_3Y', '은행채AAA_5Y']  # [A, B, C]
# 각 종목은 이미 "해당 종목 금리 − 국고채 금리" 값
```

### 비교 쌍 생성
| 쌍 | col1 | col2 | 스프레드 (col2−col1) |
|----|------|------|---------------------|
| 산금채 vs 카드채 | 산금채 spd | 카드채 spd | **카드채 spd − 산금채 spd** |
| 산금채 vs 은행채 | 산금채 spd | 은행채 spd | **은행채 spd − 산금채 spd** |
| 카드채 vs 은행채 | 카드채 spd | 은행채 spd | **은행채 spd − 카드채 spd** |

### 4가지 지표 (예: "산금채 vs 카드채")
| 지표 | 계산 | 의미 |
|------|------|------|
| **상관계수** | corr(산금 spd, 카드 spd) | 두 크레딧이 함께 움직이는 정도 |
| **스프레드** | **카드 spd − 산금 spd** | 크레딧 스프레드 차이 (뒤 − 앞) |
| **변동성** | σ(카드 spd − 산금 spd) | 크레딧 차이의 변동성 |
| **Z-score** | (현재 − 평균) / σ | 크레딧 차이가 평소 대비 몇 σ |

### 해석 예시
```
제목: "산금채 vs 카드채"  →  스프레드 = 카드채 spd − 산금채 spd

상관계수 = 0.70  →  크레딧 동조성 있으나 완벽하지 않음
Z-score = +1.8  →  카드채가 산금채 대비 상대적으로 와이드
                  → 평균회귀 기대 시: 카드채 매수(스프레드 축소) 베팅
```

---

## 6️⃣ `spreads_vs_ktb_changes` 모드 (크레딧 스프레드 변화)

**용도**: 크레딧 스프레드 일간 변동의 상관관계 분석

### 비교 쌍 생성
`spreads_vs_ktb`와 동일하나, 데이터는 **일간 변화분(diff)**

### 해석 예시
```
제목: "산금채 vs 카드채"  →  스프레드 = Δ(카드채 spd) − Δ(산금채 spd)

스프레드 = +1bp  →  오늘 카드채 크레딧이 산금채보다 1bp 더 와이드닝
```

---

## 📋 Mode 선택 가이드

| 분석 목적 | 권장 Mode | 이유 |
|-----------|-----------|------|
| 금리 레벨 간 관계 | `rates` | 금리 수준의 동조성 파악 |
| 금리 변동 민감도 | `rates_changes` | 일간 변동 상관관계 |
| 커브 트레이딩 | `spreads` | 커브 스프레드 간 관계 |
| 커브 변동 분석 | `spreads_changes` | 커브 스프레드 변동 동조성 |
| 크레딧 상대가치 | `spreads_vs_ktb` | 크레딧 스프레드 간 관계 |
| 크레딧 변동 분석 | `spreads_vs_ktb_changes` | 크레딧 변동 동조성 |

---

## ⚠️ 주의사항

### 스프레드 계산 방향 (일관된 규칙)

**모든 Mode에서 동일:**
```
제목: "A vs B"  →  스프레드 = B − A (col2 − col1, 뒤 − 앞)
```

| Mode | 제목 예시 | 스프레드 계산 |
|------|-----------|--------------|
| rates | "3Y vs 5Y" | 5Y − 3Y |
| spreads | "(5Y−3Y) vs (10Y−3Y)" | (10Y−3Y) − (5Y−3Y) |
| spreads_vs_ktb | "산금채 vs 카드채" | 카드채 spd − 산금채 spd |

### 히스토그램 기간 설정

설정 영역에서 조정:
```python
# 히스토그램 기준 기간
HIST_START_DATE = '2022-01-01'
HIST_END_DATE = '2026-01-18'
```

표기 형식: **2022.01~2026.01** (월까지 표기)

### Z-score 해석

| Z-score | 의미 | 페어트레이딩 시사점 |
|---------|------|---------------------|
| > +2σ | 스프레드(뒤−앞)가 평소보다 매우 넓음 | 축소 방향 베팅 고려 |
| +1σ ~ +2σ | 스프레드가 평소보다 다소 넓음 | 관찰 |
| −1σ ~ +1σ | 정상 범위 | 중립 |
| −2σ ~ −1σ | 스프레드가 평소보다 다소 좁음 | 관찰 |
| < −2σ | 스프레드(뒤−앞)가 평소보다 매우 좁음 | 확대 방향 베팅 고려 |

---

## 📊 그래프 패널 설명

| 패널 | 내용 | 히스토그램 |
|------|------|------------|
| **1. 롤링 상관계수** | col1과 col2의 동적 상관관계 추이 | 히스토그램 기준기간 내 분포 |
| **2. 스프레드** | col2 − col1 값 추이 (뒤 − 앞) | 레벨 분포 |
| **3. 변동성** | 스프레드의 롤링 표준편차 | 변동성 분포 |
| **4. Z-score** | 스프레드의 표준화 점수 | Z-score 분포 |

---

## 실전 활용 예시

### 예시 1: 3-5-10 버터플라이 분석
```python
COLUMNS_9 = ['국고채RF_3Y', '국고채RF_5Y', '국고채RF_10Y']
MODE_9 = 'spreads'
```
→ "(5Y−3Y) vs (10Y−5Y)" 분석
→ 스프레드 = (10Y−5Y) − (5Y−3Y)
→ 버터플라이 기회 포착

### 예시 2: 크레딧 상대가치
```python
COLUMNS_9 = ['산금채AAA_5Y', '카드채AA+_5Y', '은행채AAA_5Y']
MODE_9 = 'spreads_vs_ktb'
```
→ "산금채 vs 카드채" 분석
→ 스프레드 = 카드채 spd − 산금채 spd
→ 동일 만기 크레딧 간 상대가치 분석

### 예시 3: 금리 레벨 동조성
```python
COLUMNS_9 = ['국고채RF_3Y', '국고채RF_10Y', '미국채_10Y']
MODE_9 = 'rates_changes'
```
→ "국고10Y vs 미국채10Y" 분석
→ 스프레드 = Δ미국채10Y − Δ국고10Y
→ 한미 금리 변동 상관관계 분석
