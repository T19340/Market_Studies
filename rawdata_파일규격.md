# Raw Data 파일 규격서

이 문서는 `태은이를_위한_사랑의_템플릿_v1.1.ipynb`에서 사용하는 3개 데이터 파일의 **정확한 형식**을 기술합니다.

---

## 파일 목록

| # | 파일명 | 포맷 | 용도 | 코드 내 설정 |
|:-:|--------|------|------|:------------:|
| 1 | `금리_스프레드표.xlsb` | Excel Binary | 일별 종가 금리 (전 섹터) | `DataConfig.file_path` |
| 2 | `국고지표정보.xlsx` | Excel xlsx | 국채/통안채 수익률 OHLC + 투자자별 | `OHLCVConfig.file_path` |
| 3 | `국고선물정보.xlsx` | Excel xlsx | 국채선물 가격 OHLCV + 부가지표 | `FuturesConfig.file_path` |

기본 경로는 `D:\채권\작업중\` 아래이며, Cell 0의 각 Config 클래스에서 변경 가능합니다.

---

## 1. 금리_스프레드표.xlsb

> 기존 모듈(Cell 1 `BondDataLoader`)이 win32com으로 DRM 해제 후 읽습니다.

### 시트 구성

| 시트명 | 내용 |
|--------|------|
| `Rates` | 일별 종가 금리 (전 종목) |
| `Spread` | 국고채 대비 스프레드 (전 종목) |

### Rates 시트 구조

```
Row 1~3: (사용 안 함)
Row 4:   컬럼 헤더
Row 5+:  데이터
Col A:   일자
Col B~:  종목별 금리 (소수점, 단위: %)
```

**컬럼명 규칙**: `{섹터명}{신용등급}_{만기}`

```
국고채RF_3M    국고채RF_3Y    국고채RF_10Y   국고채RF_30Y
통안채RF_1Y    산금채AAA_3Y   공사채AA+_5Y
은행채AAA_1Y   카드채AA+_3Y   캐피탈AA-_1Y
회사채AA-_3Y   ...
```

**데이터 예시**:
```
일자          국고채RF_3Y   카드채AA+_3Y   산금채AAA_5Y
2026-01-22    3.09         3.65          3.42
2026-01-23    3.13         3.66          3.43
...
```

### Spread 시트 구조

Rates 시트와 동일한 레이아웃. 값은 국고채 대비 스프레드(bp 또는 %).

---

## 2. 국고지표정보.xlsx

> Cell 10 `BondOHLCVLoader`가 openpyxl로 읽습니다.

### 전체 레이아웃

```
┌─────────────────────────────────────────────────────────────────────┐
│ Row 1: 메타데이터 (키-값 쌍, 가로 배치)                              │
│ Row 2: 종목명 (가로 배치, 블록 시작 위치에만 기록)                     │
│ Row 3: 컬럼 헤더 (각 블록마다 동일한 25개 헤더 반복)                   │
│ Row 4+: 데이터                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Row 1: 메타데이터

| Col | 값 (예시) | 의미 |
|:---:|-----------|------|
| A | `시작` | 키 |
| B | `2026-01-22` | 데이터 시작일 (datetime) |
| C | `종료` | 키 |
| D | `2026-02-10` | 데이터 종료일 (datetime) |
| E | `Data 개수` | 키 |
| F | `100` | 요청한 데이터 행 수 |
| G | `주기` | 키 |
| H | `일` | 일간 데이터 |
| I | `정렬` | 키 |
| J | `A` | 오름차순(A) |
| K | `영업일` | 키 |
| L | `2` | 영업일 기준 |
| M | `시세산출` | 키 |
| N | `종가` | 종가 기준 |

> 코드에서 Row 1은 무시합니다. 참고 정보일 뿐입니다.

### Row 2: 종목명 (가로 블록 배치)

**9개 종목**, 각각의 블록 시작 열에만 종목명이 기록됩니다.

| Col | 종목명 |
|:---:|--------|
| 1 | `국고 2Y` |
| 27 | `국고 3Y` |
| 52 | `국고 5Y` |
| 77 | `국고 10Y` |
| 102 | `국고 20Y` |
| 127 | `국고 30Y` |
| 152 | `국고 50Y` |
| 177 | `통안 2Y` |
| 202 | `통안 3Y` |

나머지 셀은 비어 있습니다.

### Row 3: 컬럼 헤더

#### 블록 1 (Col 1~26) — 일자 포함

| Col | 헤더명 | 코드 매핑 | 설명 |
|:---:|--------|:---------:|------|
| 1 | `일자` | date | datetime, 영업일만 |
| 2 | `민평3사 수익률(산출일)` | close_eval | 민간평가3사 평균 수익률 (전일 산출) |
| 3 | `민평3사 가격(산출일)` | price | 민간평가3사 평균 가격 |
| 4 | `민평3사 듀레이션(산출일)` | duration | 듀레이션 |
| 5 | `민평3사 수익률(산출일) 당일` | — | 당일 산출 수익률 |
| 6 | `민평3사 가격(산출일) 당일` | — | 당일 산출 가격 |
| 7 | `민평3사 듀레이션(산출일) 당일` | — | 당일 산출 듀레이션 |
| **8** | **`장외-시 수익률`** | **open** | **시가 수익률** |
| **9** | **`장외-고 수익률`** | **high** | **고가 수익률** |
| **10** | **`장외-저 수익률`** | **low** | **저가 수익률** |
| **11** | **`장외-현재수익률`** | **close** | **종가(현재) 수익률** |
| **12** | **`전체 순매수 거래량`** | **net_volume → volume** | **순매수 거래량 (절대값→volume)** |
| 13 | `외국인 순매수 거래량` | — | |
| 14 | `은행 순매수 거래량` | — | |
| 15 | `보험기금 순매수 거래량` | — | |
| 16 | `자산운용(공모) 순매수 거래량` | — | |
| 17 | `자산운용(사모) 순매수 거래량` | — | 종종 비어있음 |
| 18 | `종금 순매수 거래량` | — | 종종 비어있음 |
| 19 | `선물 순매수 거래량` | — | 종종 비어있음 |
| 20 | `외국인 잔고수량` | — | |
| 21 | `은행 잔고수량` | — | |
| 22 | `보험기금 잔고수량` | — | |
| 23 | `자산운용(공모) 잔고수량` | — | |
| 24 | `자산운용(사모) 잔고수량` | — | |
| 25 | `종금 잔고수량` | — | 종종 비어있음 |
| 26 | `선물 잔고수량` | — | 종종 비어있음 |

#### 블록 2~9 (각 25컬럼) — 일자 없음

블록 1의 Col 2~26과 **동일한 헤더가 반복**됩니다. 일자(Col 1)는 블록 1을 공유합니다.

```
블록 2 (국고 3Y): Col 27~51  — 헤더 = Col 2~26과 동일
블록 3 (국고 5Y): Col 52~76
블록 4 (국고 10Y): Col 77~101
...
블록 9 (통안 3Y): Col 202~226
```

### Row 4+: 데이터

```
Row 4:  2026-01-22  2.89  9981.64  1.5756  ...  2.868  2.896  2.860  2.860  2000000000  ...
Row 5:  2026-01-23  2.86  9987.14  1.5731  ...  2.811  2.921  2.811  2.900  -2197500000  ...
...
```

**데이터 타입**:
- **일자** (Col 1): Excel datetime → `datetime.datetime(2026, 1, 22, 0, 0)`
- **수익률** (Col 2, 5, 8~11): `float`, 단위 % (예: `2.89` = 2.89%)
- **가격** (Col 3, 6): `float`, 액면 10,000 기준 (예: `9981.64`)
- **듀레이션** (Col 4, 7): `float`, 연 단위 (예: `1.5756`)
- **거래량/잔고** (Col 12~26): `int` 또는 `float`, 원화 금액 또는 수량. **빈 셀(None) 빈번**

**주의사항**:
- `장외-시/고/저/현재수익률`(Col 8~11)은 장 마감 전에는 비어있을 수 있습니다
- 당일(마지막 행)은 일자만 있고 데이터가 모두 None일 수 있습니다
- `close`가 None이면 코드가 `close_eval`(Col 2)로 자동 대체합니다
- `전체 순매수 거래량`(Col 12)은 **음수 가능** (순매도). 코드가 절대값으로 volume 처리합니다

---

## 3. 국고선물정보.xlsx

> Cell 10 `FuturesLoader`가 openpyxl로 읽습니다.

### 전체 레이아웃

국고지표정보와 동일한 3행 헤더 구조입니다.

```
Row 1: 메타데이터 (국고지표정보와 동일 형식)
Row 2: 종목명 (가로 블록 배치)
Row 3: 컬럼 헤더
Row 4+: 데이터
```

### Row 2: 종목명

**4개 종목** (연결선물):

| Col | 종목명 |
|:---:|--------|
| 1 | `3년국채 연결` |
| 52 | `5년국채 연결` |
| 102 | `10년국채 연결` |
| 152 | `30년국채 연결` |

### Row 3: 컬럼 헤더

#### 블록 1 (Col 1~51) — 일자 포함

| Col | 헤더명 | 코드 매핑 | 설명 |
|:---:|--------|:---------:|------|
| 1 | `일자` | date | datetime |
| **2** | **`현재가`** | **close** | **종가 (연결선물은 대부분 None → 정산가 fallback)** |
| **3** | **`시가`** | **open** | |
| **4** | **`고가`** | **high** | |
| **5** | **`저가`** | **low** | |
| **6** | **`거래량(장전협의포함)`** | **volume** | **실제 거래량 (정수)** |
| **7** | **`선물내재수익률`** | **yield** | **내재수익률 (%, futures_yield 모드에서 사용)** |
| **8** | **`정산가`** | **settle** | **정산가 (현재가 None일 때 close 대체)** |
| 9 | `고-저폭` | — | |
| 10 | `평균체결가` | — | |
| **11** | **`변동성`** | **volatility** | |
| 12 | `이론가` | — | |
| 13 | `시장베이시스` | — | |
| 14 | `이론베이시스` | — | |
| 15 | `민평3사이론가` | — | |
| 16 | `저평가` | — | |
| 17 | `이론갭` | — | |
| 18 | `평균선도금리` | — | |
| **19** | **`수정듀레이션`** | **duration** | |
| 20 | `국채현물가` | — | |
| 21 | `국채현물수익률` | — | |
| **22** | **`미결제약정수량`** | **oi** | **미결제약정** |
| 23 | `미결제약정증감` | — | |
| 24 | `매도성향체결수량` | — | |
| 25 | `매수성향체결수량` | — | |
| 26 | `체결건수` | — | |
| 27 | `매도5단계 호가잔량합` | — | |
| 28 | `매수5단계 호가잔량합` | — | |
| 29 | `매도총건수` | — | |
| 30 | `매수총건수` | — | |
| 31~39 | `{투자자}순매수수량` | — | 기관, 외국인, 증권/선물, 투신, 사모, 은행, 보험, 종신금, 연기금 |
| 40~51 | `{투자자}매수/매도평균단가` | — | 외국인, 기관, 증권/선물, 투신, 은행, 보험 |

#### 블록 2~4 (각 50컬럼) — 일자 없음

블록 1의 Col 2~51과 **동일한 헤더가 반복**됩니다.

```
블록 2 (5년국채 연결): Col 52~101  — 헤더 = Col 2~51과 동일
블록 3 (10년국채 연결): Col 102~151
블록 4 (30년국채 연결): Col 152~201
```

### Row 4+: 데이터

```
Row 4:  2026-01-22  None  105.02  105.09  104.90  231494  3.22  105.05  ...
Row 5:  2026-01-23  None  105.02  105.11  104.82  208419  3.22  104.92  ...
...
```

**데이터 타입**:
- **일자** (Col 1): Excel datetime
- **가격** (Col 2~5, 8, 10, 12, 15, 20): `float`, 선물 가격 (예: `105.02`)
- **거래량** (Col 6): `int` (예: `231494`)
- **수익률** (Col 7, 18, 21): `float`, % (예: `3.22`)
- **변동성** (Col 11): `float` (예: `0.68`)
- **수량** (Col 22~39): `int`, 계약 수
- **단가** (Col 40~51): `float`, 가격

**핵심 주의사항 — 연결선물의 `현재가` 문제**:

> **연결선물(Continuous Contract)은 `현재가`(Col 2)가 거의 항상 None입니다.**
> 이는 만기 전환 시 가격이 불연속이 되어, 데이터 소스에서 `현재가`를 복원하지 못하기 때문입니다.
> 코드는 자동으로 **`정산가`(Col 8)를 close로 대체**합니다.
> `시가`, `고가`, `저가`(Col 3~5)는 정상적으로 제공됩니다.

---

## 공통 규칙 정리

### 3행 헤더 구조 (국고지표정보 / 국고선물정보 공통)

```
┌─── Row 1: 메타데이터 (키-값 쌍, A1부터 가로 나열) ────────────────┐
│     시작 | 2026-01-22 | 종료 | 2026-02-10 | Data 개수 | 100 | ...│
├─── Row 2: 종목명 (블록 시작 열에만 기록, 나머지 빈 셀) ────────────┤
│     국고 2Y  |  (빈)×25  |  국고 3Y  |  (빈)×24  |  ...           │
├─── Row 3: 컬럼 헤더 (각 블록마다 반복) ───────────────────────────┤
│     일자 | 민평3사... | ... |  민평3사... | ... |                  │
├─── Row 4+: 데이터 ────────────────────────────────────────────────┤
│     2026-01-22 | 2.89 | 9981.64 | ... | 3.13 | 9928.13 | ...    │
│     2026-01-23 | 2.86 | 9987.14 | ... | 3.097 | 9937.95 | ...   │
│     ...                                                          │
└──────────────────────────────────────────────────────────────────┘
```

### 블록 구조 핵심

```
블록 1: [일자] + [데이터 컬럼 N개]  ← 일자는 여기에만 존재
블록 2:         [데이터 컬럼 N개]   ← 일자 공유
블록 3:         [데이터 컬럼 N개]
...
```

| 파일 | 블록 1 크기 | 블록 2+ 크기 | 블록 간격 |
|------|:----------:|:-----------:|:--------:|
| 국고지표정보 | 26 (1+25) | 25 | 26, 25, 25, ... |
| 국고선물정보 | 51 (1+50) | 50 | 51, 50, 50, ... |

### 종목명 감지 로직

코드는 **Row 2에서 값이 있는 셀의 열 번호**로 각 블록의 시작 위치를 파악합니다.
현재는 Config에 하드코딩되어 있지만, 실제 파일의 종목 배치가 위 표와 일치해야 합니다.

종목을 추가/삭제하려면 Cell 0의 `OHLCVConfig.instruments` 또는 `FuturesConfig.instruments` 딕셔너리를 수정하세요.

### 빈 셀 처리

| 상황 | 설명 | 코드 동작 |
|------|------|-----------|
| 당일 행 데이터 전체 None | 장 마감 전 다운로드 시 | 해당 행 NaN, dropna 시 제거됨 |
| `장외-현재수익률` None | 장중 또는 비거래일 | `민평3사 수익률`로 대체 |
| `현재가`(선물) None | 연결선물 특성 | `정산가`로 대체 |
| 순매수 거래량 일부 None | 해당 투자자 미거래 | NaN 유지 (volume은 전체 순매수만 사용) |
| 요청 행수 > 실제 데이터 | Data 개수=100이지만 20일분만 | 일자 None인 행에서 읽기 중단 |

### 날짜 형식

- Excel 내부: datetime 객체 (예: `datetime.datetime(2026, 1, 22, 0, 0)`)
- 코드에서: `pd.Timestamp`으로 변환, 인덱스로 사용
- **영업일만** 포함 (토/일/공휴일 없음)
- **오름차순 정렬** 가정 (오래된 날짜 → 최신 날짜)

### 수치 단위

| 항목 | 단위 | 예시 |
|------|------|------|
| 수익률 | % (퍼센트) | `3.09` = 3.09% |
| 선물 가격 | 원 (액면 100) | `105.02` |
| 채권 가격 | 원 (액면 10,000) | `9981.64` |
| 거래량 (채권) | 원 (금액) | `2000000000` = 20억원 |
| 거래량 (선물) | 계약 수 | `231494` |
| 듀레이션 | 연 (year) | `1.5756` |
| 미결제약정 | 계약 수 | `340000` |

---

## 4. 시장너비 데이터 (미확보)

현재 미확보 상태. 확보 시 아래 형식으로 준비하면 됩니다.

### 예상 파일: `시장너비.xlsx`

```
일자          상승종목수   하락종목수   상승거래량     하락거래량
2026-01-22    45          30          150000000    120000000
2026-01-23    38          37          130000000    140000000
...
```

- Row 1이 헤더, Row 2+가 데이터인 일반적인 Excel 형식
- 컬럼명은 `MarketBreadthConfig`의 설정과 일치해야 함:
  - `일자`, `상승종목수`, `하락종목수`, `상승거래량`, `하락거래량`
- 확보 후 Cell 0에서 `MarketBreadthConfig.available = True`로 변경

---

## 5. 파일 갱신 가이드

### 기존 파일 교체 시

같은 형식의 새 파일로 덮어쓰기만 하면 됩니다. 코드가 Row 1 메타데이터의 날짜 범위를 읽지 않으므로, 기간이 달라도 문제 없습니다.

### 데이터 기간 권장

| 분석 유형 | 최소 기간 | 권장 기간 |
|-----------|:---------:|:---------:|
| 기본 지표 계산 | 30일 | 60일 이상 |
| 장기 이동평균 (120일) | 120일 | 200일 이상 |
| 상대 게이지 (장기 250일) | 250일 | 300일 이상 |
| 일목균형표 (선행 52일) | 80일 | 120일 이상 |

> 데이터가 지표 계산 최소 기간보다 짧으면 해당 지표는 NaN 또는 N/A로 표시됩니다.
