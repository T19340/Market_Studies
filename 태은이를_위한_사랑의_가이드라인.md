# 채권 금리 기술적 분석 노트북 가이드라인

**파일**: `태은이를_위한_사랑의_템플릿_v1.1.ipynb`

---

## 1. 전체 구조

노트북은 총 **23개 셀**로 구성되며, 크게 세 영역으로 나뉩니다.

```
┌─────────────────────────────────────────────────┐
│  모듈 셀 (Cell 0~5, 10~16) — 한 번만 실행       │
│  → 클래스/함수 정의. 순서대로 한 번 실행하면 끝    │
├─────────────────────────────────────────────────┤
│  데이터 로딩 셀 (Cell 6) — 한 번만 실행           │
│  → 모든 데이터를 메모리에 올림                     │
├─────────────────────────────────────────────────┤
│  실행 셀 (Cell 7~9, 17~22) — 필요할 때마다 실행   │
│  → ⚙️ 설정 영역 수정 후 실행하면 결과 출력         │
└─────────────────────────────────────────────────┘
```

### 셀 목록

| 셀 | 역할 | 구분 |
|:---:|------|:----:|
| 0 | 설정(Config) — 전체 파라미터 중앙 관리 | 모듈 |
| 1 | DRM 엑셀 데이터 로더 (win32com) | 모듈 |
| 2 | 데이터 전처리 및 컬럼 파싱 | 모듈 |
| 3 | 상관관계 분석 엔진 | 모듈 |
| 4 | 공적분 검정 및 페어트레이딩 | 모듈 |
| 5 | 시각화 함수 모음 | 모듈 |
| **6** | **데이터 로딩** (금리 + OHLCV + 선물 + 시장너비) | **로딩** |
| 7 | 상관관계 히트맵 | 실행 |
| 8 | 롤링 상관계수 시계열 | 실행 |
| 9 | 종목 간 금리 수준 비교 | 실행 |
| 10 | OHLCV/선물/시장너비 데이터 로더 확장 | 모듈 |
| 11 | 가격 + 추세 지표 엔진 (12개 지표) | 모듈 |
| 12 | 변동성 + 모멘텀 지표 엔진 (5개 지표) | 모듈 |
| 13 | 거래량 + 시장강도 지표 엔진 (3개 지표) | 모듈 |
| 14 | 시장 너비 지표 엔진 (3개 지표) | 모듈 |
| 15 | 차트 렌더러 (특수차트 + CompositeDashboard) | 모듈 |
| 16 | 시그널 분류 엔진 (채권 방향 반전) | 모듈 |
| **17** | **이동평균 비교** | **실행** |
| **18** | **종합 멀티패널 대시보드** | **실행** |
| **19** | **변동성 + 모멘텀 분석** | **실행** |
| **20** | **거래량 + 시장강도 + 시장 너비** | **실행** |
| **21** | **특수 차트 갤러리** | **실행** |
| **22** | **시그널 종합 대시보드** | **실행** |

---

## 2. 처음 사용할 때 (초기 실행 순서)

### Step 1: 모듈 셀 전체 실행

Cell 0 → 1 → 2 → 3 → 4 → 5 → 10 → 11 → 12 → 13 → 14 → 15 → 16

> Jupyter에서 `Cell > Run All Above`로 한 번에 실행 가능합니다.
> 각 셀 끝에 `✓ ... 로딩 완료` 메시지가 출력되면 정상입니다.

### Step 2: 데이터 로딩

Cell 6 실행

출력 예시:
```
금리 데이터: (1200, 85)
국고채 대비 스프레드 데이터: (1200, 80)
✓ 국고지표 OHLCV 로딩: 9종목, 100일
✓ 국고선물 OHLCV 로딩: 4종목, 100일
ℹ️ 시장 너비 데이터 미확보 — 해당 지표 비활성

[데이터 티어 요약]
    종목 티어  OHLC  거래량  시장너비         소스  지표수
 국고 3Y 1a  True True False    futures   29
국고 20Y 1b  True True False bond_ohlcv   25
...
```

### Step 3: 원하는 실행 셀 실행

Cell 17~22 중 원하는 셀의 **⚙️ 설정 영역**을 수정한 뒤 실행합니다.

---

## 3. 데이터 소스와 티어 시스템

### 3개의 데이터 파일

| 파일 | 내용 | 경로 (Cell 0에서 설정) |
|------|------|----------------------|
| `금리_스프레드표.xlsb` | 일별 종가 금리 (크레딧 전체) | `DataConfig.file_path` |
| `국고지표정보.xlsx` | 국채/통안채 수익률 OHLC + 거래량 | `OHLCVConfig.file_path` |
| `국고선물정보.xlsx` | 국채선물 가격 OHLCV + 내재수익률 | `FuturesConfig.file_path` |

### 티어 (Tier) — 데이터 가용성에 따른 자동 분류

| 티어 | 대상 종목 | 가용 데이터 | 사용 가능 지표 수 |
|:----:|----------|-----------|:----------------:|
| **1a** | 국채선물 (3Y, 5Y, 10Y, 30Y) | 가격 OHLCV + 내재수익률 | ~29개 |
| **1b** | 국고채 지표 (2Y~50Y), 통안채 | 수익률 OHLC + 거래량 | ~25개 |
| **2** | 크레딧 채권 (산금채, 카드채 등) | 종가(일별 금리)만 | 13개 |

> 티어는 자동 판별됩니다. 실행 셀에서 `DATA_SOURCE`와 `TARGET`만 지정하면 됩니다.

### DATA_SOURCE 옵션

| 값 | 의미 | 데이터 |
|----|------|--------|
| `'bond_close'` | 크레딧 종가 (Tier 2) | 금리_스프레드표의 일별 종가 |
| `'bond_ohlcv'` | 국고/통안 수익률 (Tier 1b) | 국고지표정보의 OHLC |
| `'futures_price'` | 선물 가격 (Tier 1a) | 국고선물정보의 가격 OHLCV |
| `'futures_yield'` | 선물 내재수익률 (Tier 1a) | 국고선물정보의 내재수익률 |

---

## 4. 실행 셀 사용법

모든 실행 셀은 동일한 패턴을 따릅니다:

```python
# ┌────────────────────────────────────────────────────────────┐
# │                    ⚙️ 설정 영역                            │
# └────────────────────────────────────────────────────────────┘

DATA_SOURCE = 'bond_ohlcv'    # ← 데이터 소스 선택
TARGET = '국고 3Y'             # ← 종목 선택
START_DATE = None              # ← 기간 (None = 전체)
END_DATE = None

# ... 셀별 추가 설정 ...

# ────────────────────────────────────────────────────────────
#                    설정 영역 끝
# ────────────────────────────────────────────────────────────
```

**설정 영역만 수정하고 셀을 실행**하면 됩니다. 아래쪽 코드는 건드릴 필요 없습니다.

---

### Cell 17: 이동평균 비교

여러 종류의 이동평균을 한 차트에 겹쳐 비교합니다.

**주요 설정:**
```python
MA_LIST = [
    ('SMA', 20),      # 단순이동평균 20일
    ('SMA', 60),      # 단순이동평균 60일
    ('DEMA', 20),     # 이중지수이동평균
    ('T3', 5),        # T3 이동평균
    # ('VIDYA', 20),  # 주석 해제하면 추가
    # ('VWMA', 20),   # 거래량가중 (거래량 데이터 필요)
    # ('EMA', 12),    # 지수이동평균
]
```

> 리스트에 `(타입, 기간)` 튜플을 추가/제거하면 됩니다.

---

### Cell 18: 종합 멀티패널 대시보드 (핵심 셀)

가장 자주 사용할 셀입니다. 가격 차트 위에 오버레이를 얹고, 아래에 서브패널을 자유롭게 조합합니다.

**주요 설정:**
```python
# 메인 패널 위에 겹치는 지표
OVERLAYS_18 = ['SMA_20', 'SMA_60', 'Bollinger']

# 아래쪽 서브 패널
SUBPANELS_18 = ['MACD', 'RSI', 'Stochastic']
```

**오버레이 선택지:**

| 값 | 지표 |
|----|------|
| `'SMA_N'` | 단순이동평균 (N일) — `SMA_5`, `SMA_20`, `SMA_60` 등 |
| `'DEMA'` | 이중지수이동평균 |
| `'T3'` | T3 이동평균 |
| `'VIDYA'` | 적응형 이동평균 |
| `'VWMA'` | 거래량가중 이동평균 (거래량 필요) |
| `'Bollinger'` | 볼린저 밴드 (상/중/하한) |
| `'Ichimoku'` | 일목균형표 (전환선, 기준선, 구름) |
| `'Parabolic_SAR'` | 파라볼릭 SAR |

**서브패널 선택지:**

| 값 | 지표 | 데이터 요구 |
|----|------|:----------:|
| `'MACD'` | MACD + 시그널 + 히스토그램 | 종가 |
| `'RSI'` | RSI (14) | 종가 |
| `'Stochastic'` | Stochastic %K, %D | OHLC |
| `'Williams_R'` | Williams %R | OHLC |
| `'DMI'` | +DI, -DI, ADX | OHLC |
| `'CCI'` | CCI | OHLC |
| `'SONAR'` | SONAR | 종가 |
| `'ATR'` | ATR | OHLC |
| `'Chaikin_Vol'` | 차이킨 변동성 | OHLC |
| `'OBV'` | OBV | 종가 + 거래량 |
| `'AD_Line'` | A/D Line | OHLC + 거래량 |
| `'CMF'` | 차이킨 자금흐름 | OHLC + 거래량 |
| `'Bollinger_BW'` | 볼린저 밴드폭 | 종가 |

> 리스트 순서대로 위에서 아래로 패널이 생성됩니다. 원하는 만큼 추가/제거하세요.

---

### Cell 19: 변동성 + 모멘텀 분석

ATR, Chaikin Volatility, Stochastic, RSI, Williams %R을 한 화면에 표시합니다.

**주요 설정:**
```python
SHOW_ATR = True
SHOW_CHAIKIN_VOL = True
SHOW_STOCHASTIC = True
SHOW_RSI = True
SHOW_WILLIAMS = True
```

> `True`/`False`로 개별 패널을 켜고 끌 수 있습니다.

---

### Cell 20: 거래량 + 시장강도 + 시장 너비

**주요 설정:**
```python
# 거래량 지표 (OHLCV 데이터 필요)
SHOW_OBV = True
SHOW_AD_LINE = True
SHOW_CMF = True

# 시장 너비 (별도 데이터 확보 필요)
SHOW_AD_BREADTH = True
SHOW_TRIN = True
SHOW_MCCLELLAN = True
```

> 시장 너비 데이터가 아직 미확보 상태이면, 해당 패널은 자동으로 생략됩니다.

---

### Cell 21: 특수 차트 갤러리

전통적인 기술적 분석 차트를 격자 형태로 한 번에 출력합니다.

**주요 설정:**
```python
SHOW_CANDLE = True          # 캔들차트
SHOW_BAR = False            # 바차트
SHOW_PNF = True             # 포인트 & 피겨
SHOW_THREE_LINE = True      # 삼선전환도
SHOW_COUNTER_CLOCK = True   # 역시계곡선 (거래량 필요)
SHOW_VOLUME_PROFILE = True  # 볼륨프로파일 (거래량 필요)
SHOW_CANDLE_VOLUME = False  # 캔들 + 거래량 (별도 figure)
```

**P&F 차트 세부 설정:**
```python
PNF_BOX_SIZE = None    # None = 기본 0.01 (1bp)
PNF_REVERSAL = None    # None = 기본 3칸 반전
```

---

### Cell 22: 시그널 종합 대시보드 (핵심 셀)

모든 지표의 시그널을 한눈에 보여주는 종합 대시보드입니다.

**주요 설정:**
```python
# 상대 게이지 비교 기간 (영업일)
GAUGE_SHORT = 20     # 약 1개월
GAUGE_MEDIUM = 120   # 약 6개월
GAUGE_LONG = 250     # 약 1년
```

**출력 구조:**
```
┌──────────┬────────┬────────┬────────┬────────┬──────────────────────┐
│          │ 절대   │ 단기   │ 중기   │ 장기   │                      │
│ 지표     │ 게이지 │ (20d)  │ (120d) │ (250d) │ 값 / 해석            │
├──────────┼────────┼────────┼────────┼────────┼──────────────────────┤
│ ▼추세    │        │        │        │        │                      │
│  MACD    │ ──●─── │ ──●─── │ ───●── │ ────●─ │ ▼ -0.03 데드크로스   │
│  DMI     │ ──●─── │ ─●──── │ ──●─── │ ──●─── │ ▲ ADX 32 추세 강화중 │
│ ▼모멘텀  │        │        │        │        │                      │
│  RSI     │ ●───── │ ●───── │ ──●─── │ ───●── │ ▲ 72.1 금리과매수    │
│  ...     │        │        │        │        │                      │
└──────────┴────────┴────────┴────────┴────────┴──────────────────────┘
```

**게이지 읽는 법:**
- **절대 게이지**: 지표의 이론적 범위(예: RSI 0~100) 내 현재 위치
- **상대 게이지**: 해당 기간 내 백분위(percentile) 위치
- **좌측(●) = 매수 쪽**, **우측(●) = 매도 쪽** (채권 관점)
- **▲** = 전일 대비 시그널 강화, **▼** = 약화
- **★** = 가격과 지표 사이의 다이버전스 감지

**종합 스코어:**
- `-1.0`(강한 매도) ~ `+1.0`(강한 매수)
- `매수 N | 중립 N | 매도 N | N/A N` 형태로 집계

---

## 5. 채권 시그널 방향 규칙

이 노트북의 가장 중요한 특징은 **채권 관점 방향 반전**입니다.

채권 시장에서는 **금리 하락 = 채권 가격 상승 = 매수 기회**이므로, 주식에서의 전통적인 시그널 해석을 뒤집습니다.

| 지표 | 주식에서의 매수 | 이 노트북에서의 매수 (채권 관점) |
|------|:--------------:|:-------------------------------:|
| RSI | < 30 (과매도) | > 70 (금리 과매수 → 하락 예상) |
| Stochastic | < 20 | > 80 (금리 기준) |
| Williams %R | < -80 | > -20 (금리 기준) |
| MACD | 골든크로스 | 데드크로스 (금리 하락 추세) |
| 볼린저 | 하한선 하회 | 상한선 상회 (금리 과도 상승) |
| DMI | +DI > -DI | -DI > +DI (금리 하락 추세) |
| CCI | < -100 | > +100 (금리 과매수) |
| OBV | 상승 추세 | 하락 추세 (금리 기준) |
| CMF | > 0 (유입) | < 0 (유출, 금리 기준) |

---

## 6. 파라미터 조정

### 지표 기본 파라미터 변경 (Cell 0)

Cell 0의 `IndicatorConfig`에서 모든 지표의 기본 파라미터를 변경할 수 있습니다.

```python
@dataclass
class IndicatorConfig:
    # MACD 파라미터 변경 예시
    macd_fast: int = 12       # ← 여기를 수정
    macd_slow: int = 26
    macd_signal: int = 9

    # RSI 기간 변경
    rsi_period: int = 14      # ← 여기를 수정

    # 볼린저 밴드 설정
    bb_period: int = 20
    bb_std: float = 2.0       # 표준편차 배수

    # 시그널 분류 기준
    rsi_overbought: float = 70.0   # 과매수 기준
    rsi_oversold: float = 30.0     # 과매도 기준
    ...
```

> Cell 0 수정 후 Cell 0 재실행, 그리고 Cell 11~16도 재실행해야 반영됩니다.

### 데이터 파일 경로 변경 (Cell 0)

```python
@dataclass
class DataConfig:
    file_path: Path = Path(r"D:\채권\작업중\금리_스프레드표.xlsb")

@dataclass
class OHLCVConfig:
    file_path: Path = Path(r"D:\채권\작업중\국고지표정보.xlsx")

@dataclass
class FuturesConfig:
    file_path: Path = Path(r"D:\채권\작업중\국고선물정보.xlsx")
```

---

## 7. 자주 쓰는 사용 시나리오

### 시나리오 A: "국고 3Y 종합 분석"

1. Cell 18 설정:
```python
DATA_SOURCE_18 = 'bond_ohlcv'
TARGET_18 = '국고 3Y'
OVERLAYS_18 = ['SMA_20', 'SMA_60', 'Bollinger']
SUBPANELS_18 = ['MACD', 'RSI', 'Stochastic', 'DMI']
```
2. Cell 18 실행 → 멀티패널 대시보드 출력
3. Cell 22 설정에서 동일 종목 → 시그널 종합 확인

### 시나리오 B: "3년 국채선물 가격 기반 분석"

1. Cell 18 설정:
```python
DATA_SOURCE_18 = 'futures_price'
TARGET_18 = '3년국채 연결'
```
2. 실행 → 선물 가격 기준 차트 출력

### 시나리오 C: "카드채 AA+ 3Y (크레딧, Tier 2)"

1. Cell 18 설정:
```python
DATA_SOURCE_18 = 'bond_close'
TARGET_18 = '카드채AA+_3Y'
OVERLAYS_18 = ['SMA_20', 'SMA_60', 'Bollinger']
SUBPANELS_18 = ['MACD', 'RSI']  # OHLC 필요 지표는 제외
```

> Tier 2에서는 OHLC가 필요한 지표(Stochastic, DMI, CCI, ATR 등)가 자동으로 계산되지 않습니다. 종가 기반 대체가 가능한 Stochastic, Williams %R은 자동으로 종가 기반 버전을 사용합니다.

### 시나리오 D: "이동평균 전략 비교"

1. Cell 17 설정:
```python
MA_LIST = [
    ('SMA', 20),
    ('SMA', 60),
    ('DEMA', 20),
    ('T3', 5),
    ('VIDYA', 20),
]
```
2. 실행 → 모든 이동평균이 한 차트에 겹쳐 표시됨
3. 어떤 MA가 현재 추세를 가장 잘 따르는지 시각적으로 비교

---

## 8. 지표 레퍼런스 (32개)

### Part 1: 특수 차트 (9종, Cell 15 + Cell 21)

| # | 차트 | 필요 데이터 | 설명 |
|:-:|------|:-----------:|------|
| 1 | 캔들차트 | OHLC | 시가/고가/저가/종가로 봉 형성. 금리 기준: 하락봉=녹색 |
| 2 | 바차트 | OHLC | OHLC 바 형태 |
| 3 | P&F | 종가 | 시간 축 제거, 추세 전환만 표시 (X=상승, O=하락) |
| 4 | 삼선전환도 | 종가 | 최근 3봉 기준 반전만 표시, 노이즈 제거 |
| 5 | 역시계곡선 | 종가+거래량 | 거래량(X축) vs 가격(Y축) 궤적 — 시장 사이클 파악 |
| 6 | 캔들볼륨 | OHLC+거래량 | 캔들 + 하단 거래량 바 |
| 7 | 이퀴볼륨 | OHLC+거래량 | 봉 너비를 거래량에 비례시킴 |
| 8 | 볼륨프로파일 | 종가+거래량 | 가격대별 거래량 수평 히스토그램 + POC |
| 9 | 마켓프로파일 | 틱 데이터 | TPO 분포 (데이터 별도 필요) |

### Part 2: 가격 지표 (8종, Cell 11)

| # | 지표 | 파라미터 | 설명 |
|:-:|------|---------|------|
| 10 | SMA | 기간(5,10,20,60,120) | 단순이동평균 |
| 11 | VWMA | 기간 | 거래량가중 이동평균 |
| 12 | 일목균형표 | 9,26,52 | 전환선/기준선/선행스팬/후행스팬/구름 |
| 13 | 볼린저 밴드 | 기간(20), 표준편차(2) | 중심선 ± 2σ, %B, Bandwidth |
| 14 | DEMA | 기간 | 이중지수이동평균 (래그 감소) |
| 15 | 파라볼릭 SAR | AF 0.02~0.20 | 추세 반전 포물선 |
| 16 | T3 | 기간, vfactor(0.7) | 초평활 이동평균 |
| 17 | VIDYA | 기간 | 변동성 적응형 이동평균 |

### Part 3: 추세 지표 (4종, Cell 11)

| # | 지표 | 파라미터 | 설명 |
|:-:|------|---------|------|
| 18 | DMI/ADX | 기간(14) | 추세 방향(+DI/-DI) + 추세 강도(ADX) |
| 19 | CCI | 기간(20) | ±100 기준 과매수/과매도 판별 |
| 20 | MACD | 12,26,9 | 이동평균 수렴확산. 시그널 교차로 추세 판별 |
| 21 | SONAR | 기간(14) | EMA 기울기 — 추세 가속/감속 감지 |

### Part 4: 변동성 지표 (2종, Cell 12)

| # | 지표 | 파라미터 | 설명 |
|:-:|------|---------|------|
| 22 | ATR | 기간(14) | 평균 True Range — 변동성 크기 (방향 없음) |
| 23 | Chaikin Vol | EMA(10), ROC(10) | 고저 범위의 확장/축소 비율 |

### Part 5: 모멘텀 지표 (3종, Cell 12)

| # | 지표 | 파라미터 | 설명 |
|:-:|------|---------|------|
| 24 | Stochastic | K(14), D(3), smooth(3) | %K/%D 교차, 80/20 과매수/과매도 |
| 25 | RSI | 기간(14) | 0~100, 70/30 과매수/과매도 |
| 26 | Williams %R | 기간(14) | 0~-100, -20/-80 과매수/과매도 |

### Part 6: 거래량/시장강도 (3종, Cell 13)

| # | 지표 | 필요 데이터 | 설명 |
|:-:|------|:-----------:|------|
| 27 | OBV | 종가+거래량 | 누적 거래량 방향 — 가격과의 다이버전스 감지 |
| 28 | A/D Line | OHLC+거래량 | CLV 가중 누적 거래량 — 매집/분산 판별 |
| 29 | CMF | OHLC+거래량 | A/D Line의 오실레이터 버전 (±1 범위) |

### Part 7: 시장 너비 (3종, Cell 14)

| # | 지표 | 필요 데이터 | 설명 |
|:-:|------|:-----------:|------|
| 30 | 등락주선 | 상승/하락 종목수 | 시장 전체 방향 확인 |
| 31 | TRIN | 상승하락 종목+거래량 | >1 약세, <1 강세 (시장 품질) |
| 32 | McClellan | 상승/하락 종목수 | 단기/장기 EMA 차이 — 시장 과열/침체 |

> 시장 너비 지표(30~32)는 별도 데이터 확보 후 활성화됩니다. `MarketBreadthConfig.available = True`로 변경하세요.

---

## 9. 트러블슈팅

### "종목 not found" 에러

`TARGET`에 입력한 종목명이 데이터에 없습니다.
- 국채: `'국고 2Y'`, `'국고 3Y'`, `'국고 5Y'`, `'국고 10Y'`, `'국고 20Y'`, `'국고 30Y'`, `'국고 50Y'`
- 통안: `'통안 2Y'`, `'통안 3Y'`
- 선물: `'3년국채 연결'`, `'5년국채 연결'`, `'10년국채 연결'`, `'30년국채 연결'`
- 크레딧: `'카드채AA+_3Y'` 등 (rates 컬럼명과 정확히 일치해야 함)

### "OHLCV 데이터 없음" 에러

`DATA_SOURCE`가 `'bond_ohlcv'`나 `'futures_price'`인데 해당 종목이 없는 경우입니다.
- 크레딧 채권은 `DATA_SOURCE = 'bond_close'`를 사용하세요.

### 마지막 행이 NaN

당일(장 마감 전) 데이터는 날짜만 있고 값이 비어있을 수 있습니다. 정상입니다.

### 지표가 N/A로 표시됨

데이터 기간이 지표 계산에 필요한 최소 기간보다 짧습니다. 예: CCI(20)는 최소 20일 필요.

### 모듈 셀 수정 후 반영 안 됨

Cell 0(Config)이나 모듈 셀(10~16)을 수정했으면 **해당 셀부터 아래로 다시 실행**해야 합니다. 또는 `Kernel > Restart & Run All`을 사용하세요.
