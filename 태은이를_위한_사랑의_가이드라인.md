# 채권 금리 기술적 분석 노트북 가이드라인

**파일**: `태은이를_위한_사랑의_템플릿_v2.ipynb`
**최종 수정**: 2026-02-11

---

## 0. 변경 이력

### v2.1 — 전면 재설계 (2026-02-11)

| 변경 | 내용 |
|------|------|
| **셀 통합** | 23셀 → 7셀. 모듈 12개를 Cell 1 하나로 합침 |
| **수익률/가격 버그** | `DataTierDetector`가 선물가격(106)을 반환하던 문제 → `source_preference` 파라미터 추가 |
| **설정 중앙화** | `ExecutionConfig` dataclass로 모든 설정을 Cell 0에 통합 |
| **지표 대시보드** | 5개 실행셀 → 4페이지 단일 셀 (추세/모멘텀/변동성+거래량/특수차트) |
| **시그널 게이지** | 10% 구간 스트라이프 + 녹→황→적 그라디언트 + 큰 마커 |
| **날짜축 자동포맷** | `setup_date_axis()` — 기간에 따른 자동 눈금 간격 |
| **A4 규격** | 모든 Figure를 A4 세로/가로 크기로 통일 |
| **스타일 통일** | `CHART_STYLE` 딕셔너리 + `apply_chart_style()` 전체 적용 |
| **Export** | Cell 6에서 Excel(3시트) + PNG + PDF 자동 저장 |
| **특수차트 해석** | 각 차트 아래에 한글 해석 텍스트 추가 |

### v2.0 — 초기 패치 (2026-02-10)

| 문제 | 원인 | 해결 |
|------|------|------|
| 데이터 파일 미존재 | 별도 xlsx 경로 참조 | `TA_rawdata.xlsb` 단일 파일로 통합 |
| win32com 사용 | Windows COM → WSL 불가 | `pyxlsb` 라이브러리로 전면 교체 |
| 셀 실행 순서 오류 | 로더 정의 전에 사용 | 셀 순서 재배치 |
| matplotlib API 오류 | `axhline(transform=...)` 비호환 | `transform` 파라미터 제거 |
| numpy 읽기 전용 배열 | `corr.copy().values` read-only | `to_numpy(copy=True)` 사용 |

---

## 1. 전체 구조

노트북은 총 **7개 셀**(Cell 0~6)로 구성됩니다.

```
┌─────────────────────────────────────────────────┐
│  Cell 0: 설정 — 모든 파라미터를 여기서 수정       │
├─────────────────────────────────────────────────┤
│  Cell 1: 모듈 — 클래스/함수 전체 정의             │
├─────────────────────────────────────────────────┤
│  Cell 2: 데이터 로딩 — xlsb에서 메모리로           │
├─────────────────────────────────────────────────┤
│  Cell 3: 상관분석 — 히트맵+롤링+비교 통합          │
├─────────────────────────────────────────────────┤
│  Cell 4: 기술적 지표 대시보드 — 4페이지 자동 생성   │
├─────────────────────────────────────────────────┤
│  Cell 5: 시그널 종합 대시보드 — 게이지+스코어       │
├─────────────────────────────────────────────────┤
│  Cell 6: 저장 — Excel + PNG + PDF 자동 Export    │
└─────────────────────────────────────────────────┘
```

### 셀 목록

| 셀 | 역할 | 실행 빈도 |
|:--:|------|:--------:|
| **0** | 통합 설정 (ExecutionConfig + 모든 dataclass) | 최초 1회, 설정 변경시 재실행 |
| **1** | 모듈 통합 (유틸리티 + 로더 + 엔진 + 렌더러 + 시그널) | 최초 1회 |
| **2** | 데이터 로딩 (금리 + OHLCV + 선물) | 최초 1회 |
| **3** | 상관분석 (히트맵 + 롤링상관 + 금리비교) | 필요시 |
| **4** | 기술적 지표 4페이지 대시보드 | 필요시 |
| **5** | 시그널 종합 대시보드 (게이지 + 스코어) | 필요시 |
| **6** | Excel/이미지 저장 | 필요시 |

---

## 2. 실행 순서

### 처음 사용할 때

```
Cell 0 → Cell 1 → Cell 2
```

이 세 셀을 실행하면 모든 준비가 완료됩니다. 이후 Cell 3~6을 원하는 순서로 실행하면 됩니다.

### 일상적 사용

1. Cell 0에서 `CFG = ExecutionConfig(...)` 설정 수정
2. Cell 0 재실행
3. Cell 4, 5, 6 등 원하는 셀 실행

> **중요**: Cell 0의 설정만 바꾸면 Cell 1~2는 재실행할 필요 없습니다. Cell 4~6은 항상 `CFG` 변수를 참조합니다.

---

## 3. 설정 (Cell 0)

모든 사용자 설정은 Cell 0의 `ExecutionConfig`에 집중되어 있습니다.

```python
CFG = ExecutionConfig(
    # ── 공통 ──
    data_source = 'bond_ohlcv',     # 데이터 소스 선택
    target = '국고 3Y',              # 분석 종목
    start_date = None,               # 시작일 (None = 전체)
    end_date = None,                 # 종료일

    # ── 저장 ──
    save_dir = Path('output'),       # 저장 디렉토리
    save_excel = True,               # Excel 저장 여부
    save_graphs = True,              # 이미지 저장 여부

    # ── 상관분석 (Cell 3) ──
    corr_columns = ['국고채RF_3Y', '산금채AAA_5Y', '카드채AA+_3Y', '은행채AAA_5Y'],
    corr_mode = 'spreads_changes',   # 상관 모드
    compare_columns = ['국고채RF_3Y', '국고채RF_5Y', '국고채RF_10Y'],

    # ── 대시보드 (Cell 4) ──
    overlays = ['SMA_20', 'SMA_60', 'Bollinger'],
    show_special_charts = True,      # 특수차트 페이지 표시

    # ── 시그널 (Cell 5) ──
    gauge_short = 20,                # 단기 게이지 (약 1개월)
    gauge_medium = 120,              # 중기 게이지 (약 6개월)
    gauge_long = 250,                # 장기 게이지 (약 1년)
)
```

### DATA_SOURCE 옵션

| 값 | 의미 | 대상 종목 | Y축 범위 |
|----|------|----------|---------|
| `'bond_close'` | 크레딧 종가 (Tier 2) | 카드채, 산금채 등 | 금리 (%) |
| `'bond_ohlcv'` | 국고/통안 수익률 OHLCV (Tier 1b) | 국고 2Y~50Y, 통안 2Y~3Y | 금리 (%) |
| `'futures_price'` | 선물 가격 (Tier 1a) | 3Y/5Y/10Y/30Y 국채선물 | 가격 (원) |
| `'futures_yield'` | 선물 내재수익률 (Tier 1a) | 3Y/5Y/10Y/30Y 국채선물 | 금리 (%) |

---

## 4. 데이터 소스

### 단일 데이터 파일: `TA_rawdata.xlsb`

모든 데이터는 하나의 xlsb 파일 내 4개 시트에서 로딩됩니다.

| 시트 | 내용 | 행 구조 | 컬럼 수 |
|------|------|---------|:-------:|
| `Rates` | 일별 종가 금리 (크레딧 전체) | Row 4=헤더, Row 5+=데이터 | 225개 |
| `Spread` | 국고채 대비 스프레드 | Row 4=헤더, Row 5+=데이터 | 136개 |
| `국고지표정보` | 국채/통안채 수익률 OHLCV | Row 2=종목명, Row 3=헤더, Row 4+=데이터 | 226개 |
| `Futures` | 국채선물 가격 OHLCV + 내재수익률 | Row 2=종목명, Row 3=헤더, Row 4+=데이터 | 197개 |

**데이터 특성**:
- 날짜는 Excel 시리얼 번호(float)로 저장 → 자동 변환됨
- 역시간순(최신순) 정렬 → 자동으로 오름차순 반전
- 당일 미마감 행(날짜만 있고 데이터 없음) → 자동 스킵
- `"조회요청실패"` 행 → 자동 스킵

### 필수 라이브러리

```bash
pip install pyxlsb openpyxl
```

---

## 5. 출력물 설명

### Cell 3: 상관분석

세 가지 차트를 하나의 셀에서 생성합니다:
1. **히트맵**: 선택 종목 간 상관계수 행렬 (6가지 모드)
2. **롤링 상관계수**: 종목 쌍별 롤링 상관계수 + 스프레드 + Z-score
3. **금리 비교**: 선택 종목들의 금리 수준 시계열 비교

### Cell 4: 기술적 지표 대시보드 (4페이지)

**Page 1 — 가격 + 추세** (A4 세로):
- 메인: 종가 + MA 오버레이 (SMA, DEMA, T3, Bollinger 등)
- MACD + 시그널 + 히스토그램
- DMI (+DI, -DI) + ADX
- CCI
- SONAR

**Page 2 — 모멘텀** (A4 세로):
- 종가 + 볼린저밴드
- RSI (70/30 기준선)
- Stochastic (%K + %D)
- Williams %R (-20/-80 기준선)
- 볼린저 %B + Bandwidth

**Page 3 — 변동성 + 거래량** (A4 세로):
- 종가 + 거래량 (이중축)
- ATR
- Chaikin Volatility
- OBV
- CMF
- A/D Line

**Page 4 — 특수차트 갤러리** (A4 가로, 2x3):
- 캔들차트, P&F, 삼선전환도
- 역시계곡선, 볼륨프로파일, 캔들볼륨
- 각 차트 아래에 한글 해석 텍스트 표시

### Cell 5: 시그널 종합 대시보드

```
┌──────────────┬─────────────┬─────────────┬─────────────┐
│ 지표 / 시그널 │ 단기(20d)   │ 중기(120d)  │ 장기(250d)  │
├──────────────┼─────────────┼─────────────┼─────────────┤
│ ▼ 추세 지표  │             │             │             │
│  MACD  매수 + │ ████●─────  │ ██████●───  │ ████████●─  │
│  DMI   중립 = │ ──────●───  │ ────●─────  │ ──────●───  │
├──────────────┼─────────────┼─────────────┼─────────────┤
│ ▼ 모멘텀 지표 │             │             │             │
│  RSI   매수 + │ ███████●──  │ █████●────  │ ██████●───  │
│  ...          │             │             │             │
└──────────────┴─────────────┴─────────────┴─────────────┘
종합 스코어: +0.35   매수: 5 / 매도: 2 / 중립: 3
```

**게이지 읽는 법**:
- 좌측(0%) = 하위/매수 쪽, 우측(100%) = 상위/매도 쪽 (채권 관점)
- 10% 구간 스트라이프 + 녹→황→적 배경 그라디언트
- O 마커 = 현재 백분위 위치 (위에 % 숫자 표시)
- [D] = 다이버전스 감지, + = 강화, - = 약화, = = 안정

### Cell 6: 저장

**Excel** (`{종목}_{소스}_{날짜}.xlsx`):
- Sheet "지표원시값": 날짜 × 지표명 매트릭스
- Sheet "시그널요약": 지표별 signal, gauge, direction, divergence
- Sheet "종합스코어": composite score + 카운트

**이미지**:
- 개별 PNG: `{종목}_{차트이름}_{날짜}.png`
- 통합 PDF: `{종목}_{소스}_{날짜}_전체.pdf`

---

## 6. 채권 시그널 방향 규칙

**채권 관점 방향 반전**: 금리 하락 = 채권 가격 상승 = 매수 기회

| 지표 | 주식에서의 매수 | 이 노트북의 매수 (채권 관점) |
|------|:--------------:|:---------------------------:|
| RSI | < 30 (과매도) | > 70 (금리 과매수 → 하락 예상) |
| Stochastic | < 20 | > 80 (금리 기준) |
| Williams %R | < -80 | > -20 (금리 기준) |
| MACD | 골든크로스 | 데드크로스 (금리 하락 추세) |
| 볼린저 | 하한선 하회 | 상한선 상회 (금리 과도 상승) |
| DMI | +DI > -DI | -DI > +DI (금리 하락 추세) |
| CCI | < -100 | > +100 (금리 과매수) |
| OBV | 상승 추세 | 하락 추세 (금리 기준) |
| CMF | > 0 (유입) | < 0 (유출, 금리 기준) |

---

## 7. 티어(Tier) 시스템

데이터 가용성에 따라 종목별로 자동 분류됩니다.

| 티어 | 대상 종목 | 가용 데이터 | 사용 가능 지표 수 |
|:----:|----------|-----------|:----------------:|
| **1a** | 국채선물 (3Y, 5Y, 10Y, 30Y) | 가격 OHLCV + 내재수익률 | ~29개 |
| **1b** | 국고채 지표 (2Y~50Y), 통안채 (2Y, 3Y) | 수익률 OHLC + 거래량 | ~25개 |
| **2** | 크레딧 채권 (산금채, 카드채 등) | 종가(일별 금리)만 | 13개 |

---

## 8. 자주 쓰는 사용 시나리오

### 시나리오 A: "국고 3Y 종합 분석"

```python
CFG = ExecutionConfig(
    data_source='bond_ohlcv',
    target='국고 3Y',
    overlays=['SMA_20', 'SMA_60', 'Bollinger'],
)
```
Cell 0 → Cell 4 → Cell 5 실행

### 시나리오 B: "3년 국채선물 가격 기반 분석"

```python
CFG = ExecutionConfig(
    data_source='futures_price',
    target='3년국채 연결',
)
```

### 시나리오 C: "카드채 AA+ 3Y (크레딧, Tier 2)"

```python
CFG = ExecutionConfig(
    data_source='bond_close',
    target='카드채AA+_3Y',
    overlays=['SMA_20', 'SMA_60', 'Bollinger'],
)
```

> Tier 2에서는 OHLC가 필요한 지표(Stochastic, DMI, CCI, ATR 등)가 자동으로 N/A 처리됩니다.

### 시나리오 D: "상관분석만"

```python
CFG = ExecutionConfig(
    corr_columns=['국고채RF_3Y', '산금채AAA_5Y', '카드채AA+_3Y', '은행채AAA_5Y'],
    corr_mode='spreads_changes',
)
```
Cell 0 → Cell 3 실행

---

## 9. 파라미터 조정

### 지표 기본 파라미터 (Cell 0)

Cell 0의 `IndicatorConfig`에서 모든 지표의 기본 파라미터를 변경할 수 있습니다.

```python
@dataclass
class IndicatorConfig:
    macd_fast: int = 12
    macd_slow: int = 26
    macd_signal: int = 9
    rsi_period: int = 14
    bb_period: int = 20
    bb_std: float = 2.0
    rsi_overbought: float = 70.0
    rsi_oversold: float = 30.0
    ...
```

> Cell 0 수정 후 **Cell 0만 재실행**하면 됩니다. Cell 1~2는 재실행 불필요.

### 데이터 파일 경로 (Cell 0)

```python
@dataclass
class DataConfig:
    file_path: Path = Path("TA_rawdata.xlsb")
    rates_sheet: str = 'Rates'
    spread_sheet: str = 'Spread'
```

---

## 10. 지표 레퍼런스 (29개 + 특수차트 6종)

### 가격 지표 (8종)

| 지표 | 파라미터 | 설명 |
|------|---------|------|
| SMA | 기간(5,10,20,60,120) | 단순이동평균 |
| VWMA | 기간 | 거래량가중 이동평균 |
| 일목균형표 | 9,26,52 | 전환선/기준선/선행스팬/후행스팬/구름 |
| 볼린저 밴드 | 기간(20), 표준편차(2) | 중심선 ± 2σ, %B, Bandwidth |
| DEMA | 기간 | 이중지수이동평균 (래그 감소) |
| 파라볼릭 SAR | AF 0.02~0.20 | 추세 반전 포물선 |
| T3 | 기간, vfactor(0.7) | 초평활 이동평균 |
| VIDYA | 기간 | 변동성 적응형 이동평균 |

### 추세 지표 (4종)

| 지표 | 파라미터 | 설명 |
|------|---------|------|
| DMI/ADX | 기간(14) | 추세 방향(+DI/-DI) + 추세 강도(ADX) |
| CCI | 기간(20) | ±100 기준 과매수/과매도 판별 |
| MACD | 12,26,9 | 이동평균 수렴확산. 시그널 교차로 추세 판별 |
| SONAR | 기간(14) | EMA 기울기 — 추세 가속/감속 감지 |

### 변동성 지표 (2종)

| 지표 | 파라미터 | 설명 |
|------|---------|------|
| ATR | 기간(14) | 평균 True Range — 변동성 크기 |
| Chaikin Vol | EMA(10), ROC(10) | 고저 범위 확장/축소 비율 |

### 모멘텀 지표 (3종)

| 지표 | 파라미터 | 설명 |
|------|---------|------|
| Stochastic | K(14), D(3), smooth(3) | %K/%D 교차, 80/20 과매수/과매도 |
| RSI | 기간(14) | 0~100, 70/30 과매수/과매도 |
| Williams %R | 기간(14) | 0~-100, -20/-80 과매수/과매도 |

### 거래량/시장강도 (3종)

| 지표 | 필요 데이터 | 설명 |
|------|:-----------:|------|
| OBV | 종가+거래량 | 누적 거래량 방향 — 다이버전스 감지 |
| A/D Line | OHLC+거래량 | CLV 가중 누적 거래량 — 매집/분산 판별 |
| CMF | OHLC+거래량 | A/D Line 오실레이터 (±1 범위) |

### 특수 차트 (6종)

| 차트 | 필요 데이터 | 설명 |
|------|:-----------:|------|
| 캔들차트 | OHLC | 녹색=금리하락(채권강세), 적색=금리상승(채권약세) |
| P&F | 종가 | X=금리상승, O=금리하락. 시간축 무관, 추세전환만 표시 |
| 삼선전환도 | 종가 | 최근3봉 돌파시만 신규봉 생성. 노이즈 제거 |
| 역시계곡선 | 종가+거래량 | 우상향→매집, 좌하향→분산. 시계 역방향 순환 |
| 볼륨프로파일 | 종가+거래량 | POC(적색선)=최대거래 가격대. 지지/저항 판별 |
| 캔들볼륨 | OHLC+거래량 | 캔들 + 하단 거래량 바 |

---

## 11. 트러블슈팅

### "종목 not found" 에러

`target`에 입력한 종목명이 데이터에 없습니다.

**사용 가능한 종목명:**
- 국채: `'국고 2Y'`, `'국고 3Y'`, `'국고 5Y'`, `'국고 10Y'`, `'국고 20Y'`, `'국고 30Y'`, `'국고 50Y'`
- 통안: `'통안 2Y'`, `'통안 3Y'`
- 선물: `'3년국채 연결'`, `'5년국채 연결'`, `'10년국채 연결'`, `'30년국채 연결'`
- 크레딧: `'카드채AA+_3Y'` 등 (rates 컬럼명과 정확히 일치해야 함)

### "OHLCV 데이터 없음" 에러

`data_source`가 `'bond_ohlcv'`나 `'futures_price'`인데 해당 종목이 없는 경우입니다.
→ 크레딧 채권은 `data_source='bond_close'`를 사용하세요.

### 마지막 행이 NaN

당일(장 마감 전) 데이터는 날짜만 있고 값이 비어있을 수 있습니다. 정상입니다.

### 지표가 N/A로 표시됨

데이터 기간이 지표 계산에 필요한 최소 기간보다 짧습니다.

### Cell 0 설정 변경 후 반영 안 됨

Cell 0 수정 후 반드시 Cell 0을 재실행해야 합니다. 이후 Cell 4~6은 자동으로 최신 `CFG`를 참조합니다.

### 한글 폰트 경고 (WSL/Linux)

```bash
# 나눔 폰트 설치
sudo apt install fonts-nanum
# matplotlib 캐시 삭제
rm -rf ~/.cache/matplotlib
```
